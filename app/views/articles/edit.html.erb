<div class="container">
	<%= form_for @article,  :multipart => true do |f| %>
	<p><%= f.label :title %></p>
	<p><%= f.text_field :title %></p>
	<p><%= f.label :content %></p>
	<p><%= f.text_field :article %></p>
	<p><%= f.hidden_field :image %></p> 
	<p><%= f.hidden_field :remote_image_url %></p>
	<p><%= f.hidden_field :user_id ,:value => @user_id%></p>
	<div>
	<input type="file" id="file"><br>
<img id="back_image" style="display:none;">

		<style>
			#mycanvas {
				border: 10px solid #999;
				cursor: crosshair;
			}
			.thumbnail {
				border: 2px solid #999;
				margin-right: 5px;
			}
		</style>
		<p>
			<select id="penColor">
				<option value="black">黒</option>
				<option value="red">赤</option>
				<option value="blue">青</option>
			</select>
			<select id="penWidth">
				<option value="1">細</option>
				<option value="3">中</option>
				<option value="5">太</option>
			</select>
			<input type="button" id="save" value="step1">
		</p>
		<canvas width="200" height="200" id="mycanvas">
			Canvasに対応したブラウザを用意してください。
		</canvas>
		<div id="gallery"></div> 
		<br>
		<input type="button" id="push" value="step2">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script>
		$('#file').change(
    function() {
        if ( !this.files.length ) {
            return;
        }
        var file = $(this).prop('files')[0];
        var fr = new FileReader();
        fr.onload = function() {
            $('#back_image').attr('src', fr.result ).css('display','inline');
        }
        fr.readAsDataURL(file);
    }
);
			$(function() {
				var canvas = document.getElementById('mycanvas');
				if (!canvas || !canvas.getContext) return false;
				var ctx = canvas.getContext('2d');
				var startX,
				startY,
				x,
				y,
				borderWidth = 10,
				isDrawing = false;
				$('#mycanvas').mousedown(function(e) {
					isDrawing = true;
					startX = e.pageX - $(this).offset().left - borderWidth;
					startY = e.pageY - $(this).offset().top - borderWidth;
				})
				$('#back_image').click(function(){
					var c = document.getElementById("mycanvas");
					var ctx = c.getContext("2d");
					var img = document.getElementById("back_image");
					ctx.drawImage(img, 0, 0);
				})
				.mousemove(function(e) {
					if (!isDrawing) return;
					x = e.pageX - $(this).offset().left - borderWidth;
					y = e.pageY - $(this).offset().top - borderWidth;
					ctx.beginPath();
					ctx.moveTo(startX, startY);
					ctx.lineTo(x, y);
					ctx.stroke();
					startX = x;
					startY = y;
				})
				.mouseup(function() {
					isDrawing = false;
				})
				.mouseleave(function() {
					isDrawing = false;
				});
				$('#penColor').change(function() {
					ctx.strokeStyle = $(this).val();
				});
				$('#penWidth').change(function() {
					ctx.lineWidth = $(this).val();
				});
				$('#erase').click(function() {
					if (!confirm('本当に消去しますか？')) return;
					ctx.clearRect(0, 0, canvas.width, canvas.height);
				});
				$('#save').click(function() {
					var img = $('<img id="myImg">').attr({
						width: 200,
						height:200,
						src: canvas.toDataURL()
					});
					var link = $('<a>').attr({
						href: canvas.toDataURL().replace('image/jpg', 'application/octet-stream'),
					});
					$('#gallery').append(link.append(img));
					ctx.clearRect(0, 0, canvas.width, canvas.height);
				});
				$("#push").on("click", function () {
					var _form = $("img#myImg");
					var canvas = $("img#myImg").attr("src");
			      $("#article_image").val(canvas); //画像データを二重に送信するのを防ぐ
			      $("#article_remote_image_url").val(canvas);
			      console.log(canvas);
			      _form.submit();
			    });
			});
		</script>
	</div>
	<p><%= f.submit %></p>
	<% end -%>
</div>